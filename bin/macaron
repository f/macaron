#!/usr/bin/env coffee
fs = require 'fs'
os = require 'os'
argv = require 'optimist'
	.usage 'Usage: $0 [MACRO FILE] [SOURCE FILE] [OPTIONS]'
	.demand 2
	.boolean ['b', 'c', 'bare', 'compile', 'concat']
	.alias 'b', 'bare'
	.alias 'c', 'compile'
	.default
		b: yes
		c: no
		concat: yes
	.argv

Macaron = require '../lib/index.coffee'
[macro, files...] = argv._

macaron = new Macaron
if argv.concat
	source = (macaron.getSource file for file in files)

# Fix these fucked up code
if argv.compile or argv.c
	if argv.concat
		console.log macaron.compileSource macaron.getSource(macro), source.join(os.EOL), argv
	else
		console.log macaron.compileFile macro, file, argv for file in files
else
	if argv.concat
		eval macaron.compileSource macaron.getSource(macro), source.join(os.EOL), argv
	else
		macaron.compileFileAndRun macro, file, argv for file in files
